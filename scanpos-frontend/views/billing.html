<style>
    .billing-container {
        background: #f5f6fa;
        min-height: 100vh;
        padding: 0;
    }
    
    .billing-header {
        background: white;
        border-bottom: 3px solid #2c3e50;
        padding: 15px 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .invoice-number-display {
        font-size: 1.4rem;
        font-weight: 700;
        color: #2c3e50;
    }
    
    .invoice-date {
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    
    .status-badge {
        padding: 6px 16px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .billing-workspace {
        padding: 20px 30px;
    }
    
    .product-entry-section {
        background: white;
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #3498db;
    }
    
    .form-control-billing {
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        padding: 10px 12px;
        font-size: 0.95rem;
    }
    
    .form-control-billing:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
    }
    
    .btn-add-item {
        background: #27ae60;
        border: none;
        border-radius: 4px;
        padding: 10px 24px;
        font-weight: 600;
        color: white;
        font-size: 0.95rem;
    }
    
    .btn-add-item:hover {
        background: #229954;
    }
    
    .items-grid {
        background: white;
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .items-grid-header {
        background: #34495e;
        color: white;
        padding: 12px 20px;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .billing-table {
        width: 100%;
        margin: 0;
        border-collapse: collapse;
    }
    
    .billing-table thead {
        background: #ecf0f1;
    }
    
    .billing-table th {
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        font-size: 0.85rem;
        color: #2c3e50;
        text-transform: uppercase;
        border-bottom: 2px solid #bdc3c7;
    }
    
    .billing-table th.text-right {
        text-align: right;
    }
    
    .billing-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #ecf0f1;
        font-size: 0.95rem;
        vertical-align: middle;
    }
    
    .billing-table td.text-right {
        text-align: right;
        font-family: 'Courier New', monospace;
    }
    
    .billing-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .product-name {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .qty-input {
        width: 70px;
        padding: 6px 8px;
        border: 1px solid #dfe6e9;
        border-radius: 3px;
        text-align: center;
    }
    
    .empty-items {
        padding: 40px;
        text-align: center;
        color: #95a5a6;
        font-size: 0.95rem;
    }
    
    .totals-panel {
        background: white;
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .totals-header {
        background: #34495e;
        color: white;
        padding: 12px 20px;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .totals-body {
        padding: 20px;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        font-size: 1rem;
        color: #2c3e50;
    }
    
    .total-row.subtotal {
        border-top: 1px solid #ecf0f1;
        padding-top: 15px;
        margin-top: 5px;
    }
    
    .total-row.grand-total {
        border-top: 3px double #34495e;
        margin-top: 10px;
        padding-top: 15px;
        font-size: 1.4rem;
        font-weight: 700;
        color: #27ae60;
    }
    
    .total-label {
        font-weight: 600;
    }
    
    .total-value {
        font-family: 'Courier New', monospace;
        font-weight: 600;
    }
    
    .discount-input {
        width: 120px;
        padding: 6px 10px;
        border: 1px solid #dfe6e9;
        border-radius: 3px;
        text-align: right;
        font-family: 'Courier New', monospace;
    }
    
    .actions-panel {
        background: white;
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .btn-complete-invoice {
        background: #3498db;
        border: none;
        border-radius: 4px;
        padding: 14px;
        font-weight: 600;
        font-size: 1.05rem;
        color: white;
        width: 100%;
        margin-bottom: 10px;
    }
    
    .btn-complete-invoice:hover {
        background: #2980b9;
    }
    
    .btn-complete-invoice:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
    }
    
    .btn-cancel-invoice {
        background: white;
        border: 2px solid #e74c3c;
        border-radius: 4px;
        padding: 12px;
        font-weight: 600;
        color: #e74c3c;
        width: 100%;
    }
    
    .btn-cancel-invoice:hover {
        background: #e74c3c;
        color: white;
    }
    
    .qr-section {
        background: white;
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        padding: 15px;
        text-align: center;
        margin-top: 20px;
    }
    
    .qr-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #7f8c8d;
        text-transform: uppercase;
        margin-bottom: 10px;
    }
    
    .completed-panel {
        background: white;
        border: 3px solid #27ae60;
        border-radius: 4px;
        padding: 30px;
        text-align: center;
    }
    
    .completed-icon {
        font-size: 4rem;
        color: #27ae60;
        margin-bottom: 15px;
    }
    
    .completed-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #27ae60;
        margin-bottom: 10px;
    }
    
    .btn-print {
        background: #34495e;
        border: none;
        border-radius: 4px;
        padding: 12px;
        font-weight: 600;
        color: white;
        width: 100%;
        margin-bottom: 10px;
    }
    
    .btn-print:hover {
        background: #2c3e50;
    }
    
    .btn-new-invoice {
        background: #3498db;
        border: none;
        border-radius: 4px;
        padding: 12px;
        font-weight: 600;
        color: white;
        width: 100%;
    }
    
    .btn-new-invoice:hover {
        background: #2980b9;
    }
    
    .search-dropdown {
        position: absolute;
        z-index: 1000;
        width: 100%;
        background: white;
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .search-dropdown-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #ecf0f1;
    }
    
    .search-dropdown-item:hover {
        background: #f8f9fa;
    }
    
    .search-dropdown-item:last-child {
        border-bottom: none;
    }
    
    .product-search-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }
    
    .product-search-info {
        font-size: 0.85rem;
        color: #7f8c8d;
    }
    
    .product-search-price {
        float: right;
        background: #3498db;
        color: white;
        padding: 2px 10px;
        border-radius: 3px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .ready-info {
        background: white;
        border: 2px dashed #bdc3c7;
        border-radius: 4px;
        padding: 15px 20px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .ready-info-text {
        color: #7f8c8d;
        font-size: 0.95rem;
        margin: 0;
    }
    
    .ready-info-icon {
        color: #3498db;
        font-size: 1.5rem;
        margin-right: 10px;
        vertical-align: middle;
    }
</style>

<div class="billing-container">
    <!-- Loading Indicator -->
    <div ng-show="loading" class="text-center py-5">
        <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; color: #3498db;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <!-- Invoice Header -->
    <div ng-show="!loading && invoice" class="billing-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="invoice-number-display">{{ invoice.invoice_number }}</div>
                    <div class="invoice-date"><i class="bi bi-calendar3"></i> {{ invoice.created_at | date:'dd MMM yyyy, HH:mm' }}</div>
                </div>
                <div class="col-md-6 text-end">
                    <span class="status-badge" ng-class="invoice.status === 'draft' ? 'bg-warning text-dark' : 'bg-success text-white'">
                        <i class="bi" ng-class="invoice.status === 'draft' ? 'bi-pencil-square' : 'bi-check-circle-fill'"></i>
                        {{ invoice.status }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div ng-show="!loading" class="billing-workspace">
        <div class="container-fluid">
            
            <!-- Ready State - No Invoice Yet -->
            <div ng-show="!invoice" class="row mb-3">
                <div class="col-12">
                    <div class="ready-info">
                        <i class="bi bi-info-circle-fill ready-info-icon"></i>
                        <span class="ready-info-text">Search and add products below to start billing</span>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Left Column - Product Entry & Items -->
                <div class="col-lg-8">
                    
                    <!-- Product Entry Section -->
                    <div class="product-entry-section" ng-show="!invoice || invoice.status === 'draft'">
                        <div class="section-title"><i class="bi bi-plus-square"></i> Add Product</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label mb-1">Product Name / Barcode</label>
                                <input type="text" class="form-control form-control-billing" 
                                       placeholder="Search product or scan barcode..."
                                       ng-model="searchText" ng-change="searchProducts()">
                                <!-- Search Dropdown -->
                                <div ng-show="products.length > 0" class="search-dropdown">
                                    <div class="search-dropdown-item" ng-repeat="product in products" ng-click="selectProduct(product)">
                                        <span class="product-search-price">₹{{ product.price }}</span>
                                        <div class="product-search-name">{{ product.name }}</div>
                                        <div class="product-search-info">
                                            <i class="bi bi-upc-scan"></i> {{ product.barcode || 'No barcode' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label mb-1">Quantity</label>
                                <input type="number" class="form-control form-control-billing" ng-model="quantity" min="1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label mb-1">&nbsp;</label>
                                <button class="btn btn-add-item w-100" ng-click="addProduct()" ng-disabled="loading || !selectedProduct">
                                    <span ng-if="!loading"><i class="bi bi-plus-lg"></i> ADD</span>
                                    <span ng-if="loading"><span class="btn-spinner"></span> ADDING...</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Items Grid -->
                    <div class="items-grid">
                        <div class="items-grid-header">
                            <i class="bi bi-cart3"></i> Items
                        </div>
                        <div ng-show="!invoice || items.length === 0" class="empty-items">
                            <i class="bi bi-inbox" style="font-size: 2.5rem; display: block; margin-bottom: 10px; opacity: 0.3;"></i>
                            No items added
                        </div>
                        <div ng-show="invoice && items.length > 0">
                            <table class="billing-table">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 35%;">Product Name</th>
                                        <th style="width: 10%;" class="text-right">Qty</th>
                                        <th style="width: 12%;" class="text-right">Price</th>
                                        <th style="width: 8%;" class="text-right">Tax%</th>
                                        <th style="width: 12%;" class="text-right">Tax</th>
                                        <th style="width: 13%;" class="text-right">Amount</th>
                                        <th style="width: 5%;" ng-show="invoice.status === 'draft'"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="item in items">
                                        <td>{{ $index + 1 }}</td>
                                        <td><span class="product-name">{{ item.product_name }}</span></td>
                                        <td class="text-right">
                                            <input ng-show="invoice.status === 'draft'" type="number" class="qty-input" 
                                                   ng-model="item.quantity" ng-change="updateQuantity(item)" min="1">
                                            <span ng-show="invoice.status !== 'draft'">{{ item.quantity }}</span>
                                        </td>
                                        <td class="text-right">{{ item.unit_price }}</td>
                                        <td class="text-right">{{ item.tax_percent }}</td>
                                        <td class="text-right">{{ item.line_tax.toFixed(2) }}</td>
                                        <td class="text-right"><strong>{{ item.line_total.toFixed(2) }}</strong></td>
                                        <td class="text-center" ng-show="invoice.status === 'draft'">
                                            <button class="btn btn-sm btn-danger" ng-click="deleteItem(item)" title="Remove">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Right Column - Totals & Actions -->
                <div class="col-lg-4">
                    
                    <!-- Totals Panel -->
                    <div class="totals-panel" ng-show="invoice">
                        <div class="totals-header">
                            <i class="bi bi-calculator"></i> Bill Summary
                        </div>
                        <div class="totals-body">
                            <div class="total-row">
                                <span class="total-label">Subtotal:</span>
                                <span class="total-value">₹ {{ getSubtotal().toFixed(2) }}</span>
                            </div>
                            <div class="total-row">
                                <span class="total-label">Tax:</span>
                                <span class="total-value">₹ {{ getTotalTax().toFixed(2) }}</span>
                            </div>
                            <div class="total-row subtotal">
                                <span class="total-label">Amount:</span>
                                <span class="total-value">₹ {{ (getSubtotal() + getTotalTax()).toFixed(2) }}</span>
                            </div>
                            <div class="total-row" ng-show="invoice.status === 'draft'">
                                <span class="total-label">Discount:</span>
                                <input type="number" class="discount-input" ng-model="discount" min="0" step="0.01" placeholder="0.00">
                            </div>
                            <div class="total-row" ng-show="invoice.status !== 'draft' && invoice.discount_amount > 0">
                                <span class="total-label">Discount:</span>
                                <span class="total-value" style="color: #e74c3c;">- ₹ {{ invoice.discount_amount.toFixed(2) }}</span>
                            </div>
                            <div class="total-row grand-total">
                                <span class="total-label">NET TOTAL:</span>
                                <span class="total-value">₹ {{ getGrandTotal().toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions Panel -->
                    <div class="actions-panel" ng-show="invoice && invoice.status === 'draft'">
                        <button class="btn btn-complete-invoice" ng-click="completeInvoice()" ng-disabled="items.length === 0 || loading">
                            <span ng-if="!loading"><i class="bi bi-check2-circle"></i> COMPLETE INVOICE</span>
                            <span ng-if="loading"><span class="btn-spinner"></span> PROCESSING...</span>
                        </button>
                        <button class="btn btn-cancel-invoice" ng-click="init()" ng-disabled="loading">
                            <i class="bi bi-x-circle"></i> CANCEL & NEW
                        </button>
                    </div>
                    
                    <!-- QR Code Section -->
                    <div class="qr-section" ng-show="invoice && invoice.status === 'draft'">
                        <div class="qr-title"><i class="bi bi-qr-code"></i> Mobile Scanner</div>
                        <p style="font-size: 0.8rem; color: #95a5a6; margin-bottom: 10px;">Scan to add items from phone</p>
                        <div id="qrcode"></div>
                    </div>
                    
                    <!-- Completed Panel -->
                    <div class="completed-panel" ng-show="invoice && invoice.status === 'completed'">
                        <div class="completed-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="completed-title">INVOICE COMPLETED</div>
                        <p style="color: #7f8c8d; margin-bottom: 20px;">Invoice #{{ invoice.invoice_number }}</p>
                        <button class="btn btn-print" ng-click="printInvoice()">
                            <i class="bi bi-printer"></i> PRINT INVOICE
                        </button>
                        <button class="btn btn-new-invoice" ng-click="init()">
                            <i class="bi bi-file-earmark-plus"></i> NEW INVOICE
                        </button>
                    </div>
                    
                </div>
            </div>
            
        </div>
    </div>
</div>
